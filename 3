-- Создание базы данных
CREATE DATABASE IF NOT EXISTS tourism_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE tourism_db;

-- 1. Таблица стран (справочник)
CREATE TABLE countries (
    country_id INT AUTO_INCREMENT PRIMARY KEY,
    country_name VARCHAR(100) NOT NULL,
    visa_required BOOLEAN DEFAULT FALSE,
    climate VARCHAR(50),
    description TEXT,
    UNIQUE INDEX idx_country_name (country_name)
) ENGINE=InnoDB;

-- 2. Таблица типов туров (справочник)
CREATE TABLE tour_types (
    type_id INT AUTO_INCREMENT PRIMARY KEY,
    type_name VARCHAR(50) NOT NULL,
    description TEXT,
    UNIQUE INDEX idx_type_name (type_name)
) ENGINE=InnoDB;

-- 3. Таблица клиентов (справочник)
CREATE TABLE clients (
    client_id INT AUTO_INCREMENT PRIMARY KEY,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    passport_number VARCHAR(20) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    email VARCHAR(100),
    birth_date DATE,
    registration_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE INDEX idx_passport (passport_number),
    INDEX idx_client_name (last_name, first_name)
) ENGINE=InnoDB;

-- 4. Таблица услуг (справочник)
CREATE TABLE services (
    service_id INT AUTO_INCREMENT PRIMARY KEY,
    service_name VARCHAR(100) NOT NULL,
    base_price DECIMAL(10, 2) NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    UNIQUE INDEX idx_service_name (service_name)
) ENGINE=InnoDB;

-- 5. Таблица заказов (переменная информация)
CREATE TABLE orders (
    order_id INT AUTO_INCREMENT PRIMARY KEY,
    client_id INT NOT NULL,
    country_id INT NOT NULL,
    type_id INT NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    people_count INT NOT NULL DEFAULT 1,
    total_price DECIMAL(10, 2) NOT NULL,
    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status ENUM('new', 'confirmed', 'paid', 'completed', 'cancelled') DEFAULT 'new',
    notes TEXT,
    FOREIGN KEY (client_id) REFERENCES clients(client_id) ON UPDATE CASCADE,
    FOREIGN KEY (country_id) REFERENCES countries(country_id) ON UPDATE CASCADE,
    FOREIGN KEY (type_id) REFERENCES tour_types(type_id) ON UPDATE CASCADE,
    INDEX idx_order_dates (start_date, end_date),
    INDEX idx_order_status (status),
    CHECK (end_date > start_date),
    CHECK (people_count > 0)
) ENGINE=InnoDB;

-- Таблица связи заказов и услуг (многие ко многим)
CREATE TABLE order_services (
    order_id INT NOT NULL,
    service_id INT NOT NULL,
    quantity INT NOT NULL DEFAULT 1,
    actual_price DECIMAL(10, 2) NOT NULL,
    PRIMARY KEY (order_id, service_id),
    FOREIGN KEY (order_id) REFERENCES orders(order_id) ON DELETE CASCADE,
    FOREIGN KEY (service_id) REFERENCES services(service_id) ON UPDATE CASCADE,
    CHECK (quantity > 0)
) ENGINE=InnoDB;

-- Таблица сотрудников (дополнительный справочник)
CREATE TABLE employees (
    employee_id INT AUTO_INCREMENT PRIMARY KEY,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    position VARCHAR(50) NOT NULL,
    hire_date DATE NOT NULL,
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(20),
    is_active BOOLEAN DEFAULT TRUE
) ENGINE=InnoDB;

-- Таблица назначений менеджеров на заказы
CREATE TABLE order_managers (
    order_id INT NOT NULL,
    employee_id INT NOT NULL,
    assignment_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (order_id),
    FOREIGN KEY (order_id) REFERENCES orders(order_id) ON DELETE CASCADE,
    FOREIGN KEY (employee_id) REFERENCES employees(employee_id) ON UPDATE CASCADE
) ENGINE=InnoDB;
